name: Build Windows App-Image

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Ensure Gradle wrapper or download Gradle 8.3
        run: |
          Write-Host "Checking for Gradle wrapper..."
          if (-not (Test-Path "gradlew.bat")) {
            Write-Host "Gradle wrapper not found. Downloading Gradle 8.3 distribution..."
            $gradleVersion = '8.3'
            $zipUrl = "https://services.gradle.org/distributions/gradle-$gradleVersion-bin.zip"
            $zipPath = Join-Path $env:TEMP "gradle-$gradleVersion-bin.zip"
            $dest = Join-Path $env:USERPROFILE "gradle-$gradleVersion"
            try {
              Write-Host "Downloading $zipUrl to $zipPath"
              Invoke-WebRequest -Uri $zipUrl -OutFile $zipPath -UseBasicParsing
              Write-Host "Extracting to $env:USERPROFILE"
              Expand-Archive -Path $zipPath -DestinationPath $env:USERPROFILE -Force
              $gradleHome = Join-Path $env:USERPROFILE "gradle-$gradleVersion"
              Write-Host "Adding $gradleHome\bin to PATH"
              $env:PATH = "$gradleHome\bin;$env:PATH"
              Write-Host "Generating Gradle wrapper using downloaded gradle"
              gradle wrapper
            } catch {
              Write-Host "Failed to download or use Gradle distribution: $_"
            } finally {
              if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
            }
          } else {
            Write-Host "Gradle wrapper present"
          }
        shell: powershell

      - name: Install ImageMagick (optional)
        run: choco install imagemagick -y
        shell: powershell

      - name: Build fat jar
        run: |
          if (Test-Path "gradlew.bat") {
            Write-Host "Using gradlew.bat to build fat jar"
            .\gradlew.bat clean shadowJar --no-daemon
          } else {
            Write-Host "Using system gradle to build fat jar"
            gradle clean shadowJar --no-daemon
          }
        shell: powershell

      - name: Convert icon to ICO
        run: |
          if (Test-Path "IMG\Corinthians-Simbolo-Png.png") {
            magick convert IMG\Corinthians-Simbolo-Png.png -define icon:auto-resize=64,48,32,16 IMG\Corinthians-Simbolo-Png.ico
          }
        shell: powershell

      - name: Create app-image with jpackage
        run: |
          $jar = Get-ChildItem -Path .\build\libs -Filter "*all*.jar" -Recurse | Select-Object -First 1
          if (-not $jar) { Write-Error "No fat-jar found"; exit 1 }
          $outDir = Join-Path $PWD "out"
          jpackage --name "AppCorinthians" --input ".\build\libs" --main-jar $jar.Name --main-class "com.corinthians.app.AppCorinthiansKt" --type app-image --icon ".\IMG\Corinthians-Simbolo-Png.ico" --app-version "1.0.0" --dest $outDir
          # jpackage creates a folder under $outDir\AppCorinthians
          $appFolder = Join-Path $outDir "AppCorinthians"
          if (-not (Test-Path $appFolder)) { Write-Error "App image folder not found"; exit 1 }
          $zipPath = Join-Path $outDir "AppCorinthians-win.zip"
          Write-Host "Zipping app-image to $zipPath"
          Compress-Archive -Path "$appFolder\*" -DestinationPath $zipPath -Force
          Write-Host "Zipped: $zipPath"
        shell: powershell

      - name: Upload app-image (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: app-windows-appimage
          path: out\AppCorinthians-win.zip

      - name: Upload app-image to transfer.sh and print URL
        run: |
          $zip = Get-ChildItem -Path .\out -Filter "AppCorinthians-win.zip" -Recurse | Select-Object -First 1
          if ($zip) {
            Write-Host "Uploading $($zip.FullName) to transfer.sh"
            $uri = "https://transfer.sh/" + $zip.Name
            try {
              $resp = Invoke-RestMethod -Uri $uri -Method Put -InFile $zip.FullName -UseBasicParsing
              Write-Host "transfer.sh URL: $resp"
            } catch {
              Write-Host "Upload to transfer.sh failed: $_"
            }
          } else {
            Write-Host "No app-image zip found in out\\ to upload"
          }
        shell: powershell
