name: Build Windows Installer

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Ensure Gradle wrapper
        run: |
          Write-Host "Checking for Gradle wrapper..."
          if (-not (Test-Path "gradlew.bat")) {
            Write-Host "Gradle wrapper not found, attempting to generate..."
            try {
              Write-Host "Installing gradle via choco..."
              choco install gradle -y
            } catch {
              Write-Host "choco install gradle failed: $_"
            }

            if (Get-Command gradle -ErrorAction SilentlyContinue) {
              Write-Host "Running 'gradle wrapper' to generate wrapper files"
              try {
                gradle wrapper
              } catch {
                Write-Host "gradle wrapper failed: $_"
              }
            } else {
              Write-Host "gradle not available; ensure 'gradlew.bat' is committed to the repo or install gradle in the runner."
            }
          } else {
            Write-Host "Gradle wrapper present"
          }
        shell: powershell

      - name: Install ImageMagick (optional)
        run: choco install imagemagick -y
        shell: powershell

      - name: Build fat jar
        run: .\gradlew.bat clean shadowJar --no-daemon

      - name: Convert icon to ICO
        run: |
          if (Test-Path "IMG\Corinthians-Simbolo-Png.png") {
            magick convert IMG\Corinthians-Simbolo-Png.png -define icon:auto-resize=64,48,32,16 IMG\Corinthians-Simbolo-Png.ico
          }
        shell: powershell

      - name: Create installer with jpackage
        run: |
          $jar = Get-ChildItem -Path .\build\libs -Filter "*all*.jar" -Recurse | Select-Object -First 1
          if (-not $jar) { Write-Error "No fat-jar found"; exit 1 }
          jpackage --name "AppCorinthians" --input ".\build\libs" --main-jar $jar.Name --main-class "com.corinthians.app.AppCorinthiansKt" --type exe --icon ".\IMG\Corinthians-Simbolo-Png.ico" --app-version "1.0.0" --win-shortcut --win-menu --win-dir-chooser --dest ".\out"
        shell: powershell

      - name: Upload installer (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: app-windows-installer
          path: out\*.exe

      - name: Upload installer to transfer.sh and print URL
        run: |
          $installer = Get-ChildItem -Path .\out -Filter "*.exe" -Recurse | Select-Object -First 1
          if ($installer) {
            Write-Host "Uploading $($installer.FullName) to transfer.sh"
            $uri = "https://transfer.sh/" + $installer.Name
            try {
              $resp = Invoke-RestMethod -Uri $uri -Method Put -InFile $installer.FullName -UseBasicParsing
              Write-Host "transfer.sh URL: $resp"
            } catch {
              Write-Host "Upload to transfer.sh failed: $_"
            }
          } else {
            Write-Host "No installer found in out\\ to upload"
          }
        shell: powershell
